# Manager (Domain Logic)

The *Manager* layer is primarily responsible for hosting the key business and/or workflow logic. This is also where the primary [validation](https://github.com/Avanade/CoreEx/tree/main/src/CoreEx.Validation) is performed to ensure the consistency of the request before any further processing is performed.

<br>

## Usage

This layer is generally code-generated and provides options to provide a fully custom implementation, and has extension opportunities to inject additional logic into the processing pipeline.

The [`Operation`](./Entity-Operation-Config.md) element within the `entity.beef-5.yaml` configuration primarily drives the output

There is a generated class per [`Entity`](./Entity-Entity-Config.md) named `{Entity}Manager`. There is also a corresonding interface named `I{Entity}Manager` generated so the likes of test mocking etc. can be employed. For example, if the entity is named `Person`, there will be corresponding `PersonManager` and `IPersonManager` classes.

<br/>

### Code-generated
 
An end-to-end code-generated processing pipeline generally consists of:

Step | Description
-|-
`ManagerInvoker` | The logic is wrapped by a [`ManagerInvoker`](https://github.com/Avanade/CoreEx/blob/main/src/CoreEx/Invokers/ManagerInvoker.cs). This enables the [`InvokerArgs`](https://github.com/Avanade/CoreEx/blob/main/src/CoreEx/Invokers/InvokerArgs.cs) options to be specified, including [`TransactionScopeOption`](https://docs.microsoft.com/en-us/dotnet/api/system.transactions.transactionscopeoption) and `Exception` handler. These values are generally specified in the code-generation configuration.
`OperationType` | The [`ExecutionContext.OperationType`](https://github.com/Avanade/CoreEx/blob/main/src/CoreEx/ExecutionContext.cs) is set via the [`InvokerArgs`](https://github.com/Avanade/CoreEx/blob/main/src/CoreEx/Invokers/InvokerArgs.cs) to specify the [type of operation](https://github.com/Avanade/CoreEx/blob/main/src/CoreEx/OperationType.cs) being performed (`Create`, `Read`, `Update` or `Delete`) so other functions down the call stack can infer operation intent where required.
`GenerateIdentifier` | Where the identifier for an entity needs to be generated for a `Create` operation this is specified in the code-generation configuration; or alternatively it will be generated by the underlying data source. 
`CleanUp` | Entity [`CleanUp`](https://github.com/Avanade/CoreEx/blob/main/src/CoreEx/Entities/Cleaner.cs) is the process of reviewing and updating the entity properties to make sure it is in a logical / consistent state. This is only performed where `ManagerCleanUp` configuration property is specified.
`PreValidate`&dagger; | The `PreValidate` extension opportunity; where set this will be invoked. This enables logic to be invoked _before_ the validation performed.
`Validation` | The specified validator is invoked to validate all input. The [`MultiValidator`](https://github.com/Avanade/CoreEx/blob/main/src/CoreEx/Validation/MultiValidator.cs) is used where extensions&dagger; have been selected as it provides an additional `OnValidate` extension opportunity.
`OnBefore`&dagger; | The `OnBefore` extension opportunity; where set this will be invoked. This enables logic to be invoked _before_ the primary `Operation` is performed (and after the successful validation).
`DataSvc` | The [`I{Entity}DataSvc`](./Layer-DataSvc.md) layer is invoked to orchestrate the data processing.
`OnAfter`&dagger; | The `OnAfter` extension opportunity; where set this will be invoked. This enables logic to be invoked _after_ the primary `Operation` is performed.
`CleanUp` | An Entity `CleanUp` of the response before returning. This is only performed where `ManagerCleanUp` configuration property is specified.

_&dagger; Note:_ To minimize the generated code the extension opportunities are only generated where selected. This is performed by setting the `managerExtensions` attribute to `true` within the [`Entity`](./Entity-Entity-Config.md) code-generation configuration.

The following demonstrates the generated code (a snippet from the sample [`RobotManager`](../samples/Demo/Beef.Demo.Business/Generated/RobotManager.cs)) that does not include `ManagerExtensions`:

``` csharp
public Task<Robot> CreateAsync(Robot value) => ManagerInvoker.Current.InvokeAsync(this, async _ =>
{
    value.EnsureValue().Id = await _identifierGenerator.GenerateIdentifierAsync<Guid, Robot>().ConfigureAwait(false);
    Cleaner.CleanUp(value);
    await value.Validate().Entity().With<RobotValidator>().ValidateAsync(true).ConfigureAwait(false);
    return Cleaner.Clean(await _dataService.CreateAsync(value).ConfigureAwait(false));
}, InvokerArgs.Create);
```

The following demonstrates the generated code (a snippet from the sample [`PersonManager`](../samples/Demo/Beef.Demo.Business/Generated/PersonManager.cs)) that includes `ManagerExtensions`:

``` csharp
public Task<Person> CreateAsync(Person value) => ManagerInvoker.Current.InvokeAsync(this, async _ =>
{
    value.EnsureValue().Id = await _identifierGenerator.GenerateIdentifierAsync<Guid, Person>().ConfigureAwait(false);
    Cleaner.CleanUp(value);
    await Invoker.InvokeAsync(_createOnPreValidateAsync?.Invoke(value)).ConfigureAwait(false);

    await MultiValidator.Create()
        .Add(value.Validate(nameof(value)).Entity().With<PersonValidator>())
        .Additional((__mv) => _createOnValidate?.Invoke(__mv, value))
        .ValidateAsync(true).ConfigureAwait(false);

    await Invoker.InvokeAsync(_createOnBeforeAsync?.Invoke(value)).ConfigureAwait(false);
    var __result = await _dataService.CreateAsync(value).ConfigureAwait(false);
    await Invoker.InvokeAsync(_createOnAfterAsync?.Invoke(__result)).ConfigureAwait(false);
    return Cleaner.Clean(__result);
}, InvokerArgs.Create);
```

<br/>

### Custom

A custom (`OnImplementation`) processing pipeline generally consists of:

Step | Description
-|-
`ManagerInvoker` | The logic is wrapped by a [`ManagerInvoker`](https://github.com/Avanade/CoreEx/blob/main/src/CoreEx/Invokers/ManagerInvoker.cs). This enables the [`InvokerArgs`](https://github.com/Avanade/CoreEx/blob/main/src/CoreEx/Invokers/InvokerArgs.cs) options to be specified, including [`TransactionScopeOption`](https://docs.microsoft.com/en-us/dotnet/api/system.transactions.transactionscopeoption) and `Exception` handler. These values are generally specified in the code-generation configuration.
`OperationType` | The [`ExecutionContext.OperationType`](https://github.com/Avanade/CoreEx/blob/main/src/CoreEx/ExecutionContext.cs) is set via the [`InvokerArgs`](https://github.com/Avanade/CoreEx/blob/main/src/CoreEx/Invokers/InvokerArgs.cs) to specify the [type of operation](https://github.com/Avanade/CoreEx/blob/main/src/CoreEx/OperationType.cs) being performed (`Create`, `Read`, `Update` or `Delete`) so other functions down the call stack can infer operation intent where required.
`OnImplementation` | Invocation of a named `XxxOnImplementaionAsync` method that must be implemented in a non-generated partial class.

The following demonstrates the generated code:

``` csharp
public Task AddAsync(Person person) => ManagerInvoker.Current.InvokeAsync(this, async _ =>
{
    await AddOnImplementationAsync(person).ConfigureAwait(false);
}, InvokerArgs.Unspecified);
```